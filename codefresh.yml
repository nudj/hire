version: '1.0'

steps:

  build_test:
    title: Build Test
    type: build
    image_name: nudj/hire-test
    working_directory: ${{main_clone}}
    dockerfile: Dockerfile.dev
    build_arguments:
      - NPM_TOKEN=${{NPM_TOKEN}}

  test:
    title: Test
    image: ${{build_test}}
    working_directory: 'IMAGE_WORK_DIR'
    commands:
      - ./node_modules/.bin/standard
      - ./node_modules/.bin/flow --quiet
      - ./node_modules/.bin/mocha --compilers js:babel-core/register --recursive test

  build_latest:
    title: Build Latest
    type: build
    image_name: nudj/hire
    tag: latest
    dockerfile: Dockerfile
    build_arguments:
      - NPM_TOKEN=${{NPM_TOKEN}}
      - NODE_ENV=production
      - DEBUG=true
    when:
      branch:
        only:
          - develop

  push_latest:
    title: Push Latest
    type: push
    candidate: '${{build_latest}}'
    tag: latest
    credentials:
      username: '${{dockerUsername}}'
      password: '${{dockerPassword}}'
    when:
      branch:
        only:
          - develop

  build:
    title: Build
    type: build
    image_name: nudj/hire
    tag: production
    dockerfile: Dockerfile
    build_arguments:
      - NPM_TOKEN=${{NPM_TOKEN}}
      - NODE_ENV=production
    when:
      branch:
        only:
          - LEGACY-V1
          - master

  push_legacy:
    title: Push
    type: push
    candidate: '${{build}}'
    tag: LEGACY-V1
    credentials:
      username: '${{dockerUsername}}'
      password: '${{dockerPassword}}'
    when:
      branch:
        only:
          - LEGACY-V1

  push:
    title: Push
    type: push
    candidate: '${{build}}'
    tag: 7.0.0
    credentials:
      username: '${{dockerUsername}}'
      password: '${{dockerPassword}}'
    when:
      branch:
        only:
          - master
